<!-- Content Header (Page header) -->
<!--
<section class="content-header">
	<h1><i class="fa fa-list"></i> RUH SALDO AWAL</h1>
</section>
-->

<!-- Main content -->
<section class="content">
	
	<div class="row" id="div-form">
		<div class="col-sm-12">
			
			<div class="box box-solid box-primary">
				<div class="box-header">
					<h3 class="box-title"><i class="fa fa-pencil"></i> RUH DRPP</h3>
				</div><!-- /.box-header -->
				<div class="box-body">								
					<form id="form-ruh" name="form-ruh" class="form-horizontal">
						<input type="hidden" id="inp-id" name="inp-id">
						<input type="hidden" id="inp-rekambaru" name="inp-rekambaru">
						<input type="hidden" id="_token" name="_token">
						<div class="box-body">
							<div class="form-group" >
								<label class="control-label col-sm-1">No</label>
								<div class="col-sm-3">
									<input id="nodrpp" name="nodrpp" class="form-control">
								</div>
								<div class="col-sm-1">
									<span id="warning-nodrpp" class="label label-warning warning">Required!</span>
								</div>
								<div class="col-sm-1"></div>
								<label class="control-label col-sm-1">Tanggal</label>
								<div class="col-sm-3">
									<input id="tgdrpp" name="tgdrpp" class="form-control">
								</div>
								<div class="col-sm-1">
									<span id="warning-tgdrpp" class="label label-warning warning">Required!</span>
								</div>
							</div>																			  
							<div class="form-group" >
								<label class="control-label col-sm-1">Jenis</label>
								<div class="col-sm-3">
									<select id="kdjns" name="kdjns" class="form-control chosen" data-placeholder="Pilih Kewenangan"></select>
								</div>
								<div class="col-sm-1">
									<span id="warning-kdjns" class="label label-warning warning">Required!</span>
								</div>
							</div>						  
							<div class="form-group" >
								<label class="control-label col-sm-1">Kegiatan</label>
								<div class="col-sm-3">
									<select id="kdgiat" name="kdgiat" class="form-control chosen" data-placeholder="Pilih Kewenangan"></select>
								</div>
								<div class="col-sm-1">
									<span id="warning-kdgiat" class="label label-warning warning">Required!</span>
								</div>
								<div class="col-sm-1"></div>
								<label class="control-label col-sm-1">Output</label>
								<div class="col-sm-3">
									<select id="kdoutput" name="kdoutput" class="form-control chosen" data-placeholder="Pilih Output"></select>
								</div>
								<div class="col-sm-1">
									<span id="warning-kdoutput" class="label label-warning warning">Required!</span>
								</div>
							</div>
							<div class="form-group" >
								<label class="control-label col-sm-1">Pagu </label>
								<div class="col-sm-3">
									<input id="pagu_output" name="pagu_output" disabled="true">
								</div>
								<div class="col-sm-1">
									<span id="warning-pagu_output" class="label label-warning warning">Required!</span>
								</div>
								<div class="col-sm-1"></div>
								<label class="control-label col-sm-1">Realisasi</label>
								<div class="col-sm-3">
									<input id="real_output" name="real_output" disabled="true">
								</div>
								<div class="col-sm-1">
									<span id="warning-real_output" class="label label-warning warning">Required!</span>
								</div>
							</div>
							<div class="row" id="div-tabel-drpp-detail">
							<div class="modal fade" id="drpp_detail_modal" role="dialog">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-header">
											<button type="button" class="close" data-dismiss="modal">&times;</button>
										</div>
										<div class="modal-body">
											<table id="drpp_detail_pilih" class="table table-hover">
												<thead>
													<th>Nomor</th>
													<th>Tanggal</th>
													<th>Akun</th>
													<th>Kdvalas</th>
													<th>nilai</th>
													<th>Action</th>
												</thead>
												<tbody>
												</tbody>
											
											</table>
										</div>
									</div>
								
								</div>
							
							</div>
							<div class="col-sm-12">			
								<div class="box box-solid box-primary">
									<div class="box-header">
										<div class="box-tools pull-right" id="div-tambah-detail" style="">
											<button title="Tambah Data" type="button" class="btn btn-primary" id="tambah_detail_drpp"><i class="fa fa-plus"></i></button>
										</div>
									</div><!-- /.box-header -->
									<div class="box-body table-responsive" style="overflow-x:scroll;">					
										<table id="tabel_drpp_detail" class="table table-hover">
											<thead>
												<tr>
													<th>Nomor</th>
													<th>Tanggal</th>
													<th>Akun</th>
													<th>Kdvalas</th>
													<th>nilai</th>
													</tr>
											</thead>
											<tbody>
											</tbody>
										</table>
									</div><!-- /.box-body -->
								</div><!-- /.box -->

								
							</div>
						</div>
							<div class="form-group">
								<label class="control-label col-sm-3"></label>
								<div class="col-sm-5">
									<button title="Simpan Data Ini?" id="simpan" type="button" class="btn btn-primary">Simpan</button>
									<button title="Batal"  id="batal" type="button" class="btn btn-danger">Batal</button>
								</div>
							</div>
						</div><!-- /.box-body -->
					</form>
					
				</div><!-- /.box-body -->
			</div><!-- /.box -->

			
		</div>
	</div>
	
	<!-- Small boxes (Stat box) -->
	<div class="row" id="div-tabel">
		<div class="col-lg-12">			
			<div class="box box-solid box-primary">
				<div class="box-header">
					<h3 class="box-title"><i class="fa fa-calendar"></i> Data DRPP</h3>
					<div class="box-tools pull-right" id="div-tambah" style="">
						<button title="Tambah Data" type="button" class="btn btn-primary" id="tambah"><i class="fa fa-plus"></i></button>
					</div>
				</div><!-- /.box-header -->
				<div class="box-body table-responsive" style="overflow-x:scroll;">					
					<table id="tabel-ruh" class="table table-hover">
						<thead>
							<tr>
								<th>Nomor</th>
								<th>Tanggal</th>
								<th>Kdgiat</th>
								<th>jenis</th>
								<th>Action</th>
								</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div><!-- /.box-body -->
			</div><!-- /.box -->

			
		</div>
	</div>
	
</section>
<script>
jQuery(document).ready(function() {
		jQuery('.chosen').chosen();				
		//ref jenis		
		jQuery.get('dropdown/getjenissppgu', function(result){
			jQuery('#kdjns').html(result).trigger('chosen:updated');
		});
		
		jQuery.get('dropdown/getkdgiat', function(result){
			jQuery('#kdgiat').html(result).trigger('chosen:updated');
		});
		jQuery('#kdgiat').on('change',function(){
			var data = {kdgiat : this.value};
			jQuery.get('dropdown/getkdoutput',data, function(result){
			jQuery('#kdoutput').html(result).trigger('chosen:updated');
				});
			});		
		jQuery('#kdoutput').on('change',function(){
			var data ={kdgiat :jQuery('#kdgiat').val(),kdoutput:this.value};
			jQuery.get('dipa/pagurealisasiperoutput',data,function(result){
				if (result.error == false){
					jQuery('#pagu_output').val(result.paguakhir[0].paguakhir-result.nilblokir[0].nilblokir);
					jQuery('#real_output').val( result.real.length > 0 ? result.real[0].nilmak : 0 );
					}
				});
			});
			jQuery('#tgdrpp').datepicker({
            format: 'mm-dd-yyyy',
            autoclose: true
				});
		function isNumeric(n) {
			  return !isNaN(parseFloat(n)) && isFinite(n);
			}
		function numberWithCommas(x) {
            var parts = x.toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join(".");
			}
			//modal
			jQuery('#tambah_detail_drpp').on('click',function(){
				var lanjut = form_valid('kdgiat,kdoutput');
				if (lanjut == true) {
					var data ={ kdgiat : $('#kdgiat').val(),kdoutput :$('#kdoutput').val()};
					jQuery.get('drpp/transaksi',data,function(result){
						if (result.data.length > 0) {
								$('#drpp_detail_pilih > tbody ').html('');
								for (var item in result.data ) {
									var html='<tr><td>'+result.data[item].notran+'</td><td>'+result.data[item].tgtran+'</td><td>'+result.data[item].kdakun+'</td><td>'+result.data[item].kdvalas+'</td><td>'+result.data[item].niltran+'</td></tr>';
									$('#drpp_detail_pilih > tbody ').append(html);
									
									}
								
							}
						});
					jQuery('#drpp_detail_modal').modal();
					//jQuery('#drpp_detail_pilih').find('tbody').append('<tr>1</tr><tr>2</tr><tr>3</tr><tr>4</tr><tr><tr>5</tr>');
				}
				
				});
			//data tabel
		var table=jQuery('#tabel-ruh').DataTable({
			bProcessing:true,
			oLanguage:{
				"sProcessing":   "<center><h3>Sedang proses....</h3></center>",
				"sLengthMenu":   "Tampilan _MENU_ entri",
				"sZeroRecords":  "Tidak ditemukan data yang sesuai",
				"sInfo":         "Tampilan _START_ sampai _END_ dari _TOTAL_ entri",
				"sInfoEmpty":    "Tampilan 0 hingga 0 dari 0 entri",
				"sInfoFiltered": "(disaring dari _MAX_ entri keseluruhan)",
				"sInfoPostFix":  "",
				"sSearch":       "Cari:",
				"sUrl":          "",
				"oPaginate": {
				  "sFirst":    "Awal",
				  "sPrevious": "Sebelum",
				  "sNext":     "Sesudah",
				  "sLast":     "Akhir"
				}
			},
			aaSorting: [],
			bServerSide: true,
			sAjaxSource: "drpp/monitoring"
		});
	

	function form_valid(str_id) {
		var arr_id = str_id.split(',');
		var lanjut = true;
		for(x = 0; x < arr_id.length; x++) {
			if (jQuery('#'+arr_id[x]).val() == '') {
				jQuery('#warning-'+arr_id[x]).show();
				lanjut = false;
			}
		}
		return lanjut;
	}
	
	function cari_data(id) {
		jQuery('input,textarea').val('');
		jQuery('.chosen').val('').trigger('chosen:updated');
        jQuery.getJSON('drpp/cari/'+id, function(result){
        if(result.error == false) {           
            jQuery('#inp-id').val(id);
            jQuery('#inp-rekambaru').val('0');
            jQuery('#nodrpp').val(result.data[0].nodrpp);
            jQuery('#tgdrpp').val(result.data[0].tgdrpp);
            jQuery('#kdgiat').val(result.data[0].kdgiat).trigger('chosen:updated');
            jQuery('#kdoutput').val(result.data[0].kdoutput).trigger('chosen:updated');         
            jQuery('#div-form').show();
            
        }
    });
		
	}
	
	function form_default() {
		jQuery('input,textarea').val('');
		jQuery('.chosen').val('').trigger('chosen:updated');
		jQuery('#div-form,.warning').hide();
		jQuery('#div-tabel').show();
		
	}
	
	form_default();
	
	jQuery('#tambah').click(function() {
		jQuery('#inp-rekambaru').val('1');		
		jQuery.get('drpp/getmaxno',function(result){
			jQuery('#nodrpp').val(result.data);
			});
		jQuery('#div-tabel').hide();
		jQuery('#div-form').fadeIn();
	});
	
	jQuery('#batal').click(function() {
		form_default();
	});
	
	jQuery('body').off('click', '.ubah').on('click', '.ubah', function() {
		var id = this.id;
		cari_data(id);
		jQuery('#div-tabel').hide();
		jQuery('#inp-id').val(id);
		jQuery('#inp-rekambaru').val('0'); 		  
		jQuery('#nodrpp').prop('disabled',true); 
        jQuery('#simpan').prop('disabled', false);        
	});
	
	
	
	jQuery('#simpan').click(function() {
		jQuery('#simpan').html('<span class="loading"><i class="fa fa-refresh"></i> Sedang proses.....</span>');
		jQuery('#simpan').prop('disabled',true);
		var lanjut = form_valid('nodrpp,tgdrpp,kdjns,kdgiat,kdoutput');
		if(lanjut == true) {
			jQuery.get('token', function(token) {
				if (token) {
					jQuery('#_token').val(token);
					var data = jQuery('#form-ruh').serialize();
					if (jQuery('#inp-rekambaru').val() == '1') {
						jQuery.ajax({
							url    : 'drpp/add',
							method : 'POST',
							data   : data,
							success:function(result) {
								if (result.error == false) {
									jQuery('#simpan').html('Simpan');
									jQuery('#simpan').prop('disabled',false);
									alertify.log('Proses simpan berhasil');
									form_default();
									table.ajax.reload();
								} else {
									jQuery('#simpan').html('Simpan');
									jQuery('#simpan').prop('disabled',false);
									alertify.log(result.message);
								} 
							},
							error:function(result) {
								jQuery('#simpan').html('Simpan');
								jQuery('#simpan').prop('disabled',false);
								alertify.log('Koneksi pada aplikasi/database terputus. Hubungi Administrator.');
							}
						})
					} else {
						jQuery.ajax({
							url    : 'drpp/add',
							method : 'PUT',
							data   : data,
							success:function(result) {
								if (result.error == false) {
									jQuery('#simpan').html('Simpan');
									jQuery('#simpan').prop('disabled',false);
									alertify.log('Proses simpan berhasil.');
									form_default();
									table.ajax.reload();
								} else {
									jQuery('#simpan').html('Simpan');
									jQuery('#simpan').prop('disabled',false);
									alertify.log(result.message);
								} 
							},
							error:function(result){
								jQuery('#simpan').html('Simpan');
								jQuery('#simpan').prop('disabled',false);
								alertify.log('Koneksi pada aplikasi/database terputus. Hubungi Administrator.');
							}
						})
					} 
				} else {
					jQuery('#simpan').html('Simpan');
					jQuery('#simpan').prop('disabled',false);
					alertify.log('Proses simpan gagal. Silahkan refresh halaman browser anda.');
				} 
			});
		} else {
			jQuery('#simpan').html('Simpan');
			jQuery('#simpan').prop('disabled',false);
			alertify.log('Kolom tidak boleh dikosongkan!');
		} 
	});
	
	jQuery('body').off('click', '.hapus').on('click', '.hapus', function() {
		var id = this.id;
		alertify.confirm('Hapus data ini?', function(c) {
			if (c) {
				jQuery.get('token', function(token) {
					if (token) {
						jQuery.ajax({
							url    : 'drpp/add',
							method : 'delete',
							data   : {
										_token:token, 
										id:id
									},
							success:function(result) {
								if (result.error== false) {
									alertify.log(result.message);
									table.ajax.reload();
								} else {
									alertify.log(result.message);
								} 
							},
							error:function(result) {
								alertify.log(result.message);
							}
						});
					} else {
						alertify.log('Proses hapus gagal. Silahkan refresh halaman browser anda.');
					} 
				});
			} 
		});
	});
	
});
</script>
